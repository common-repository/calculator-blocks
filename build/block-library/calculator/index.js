!function(){"use strict";var e={742:function(e,t){t.JQ=function(e){for(var t,r=e.length,n=r%3,o=[],i=16383,s=0,c=r-n;s<c;s+=i)o.push(l(e,s,s+i>c?c:s+i));return 1===n?(t=e[r-1],o.push(a[t>>2]+a[t<<4&63]+"==")):2===n&&(t=(e[r-2]<<8)+e[r-1],o.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"=")),o.join("")};for(var a=[],r=[],n=("undefined"!=typeof Uint8Array&&Uint8Array,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),o=0;o<64;++o)a[o]=n[o],r[n.charCodeAt(o)]=o;function l(e,t,r){for(var n,o,l=[],i=t;i<r;i+=3)n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),l.push(a[(o=n)>>18&63]+a[o>>12&63]+a[o>>6&63]+a[63&o]);return l.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63}},t={};function a(r){var n=t[r];if(void 0!==n)return n.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,a),o.exports}!function(){var e=window.wp.blocks,t=window.wp.element,r=window.wp.blockEditor,n=window.wp.components;const o="services: api:",l=e=>{if(!e||"object"!=typeof e||!e.id)throw Error("utils: jsonApi: flattenDocument: invalid document");return{...e.attributes||{},id:e.id}},i={data:[],isLoading:!1,hash:""};const s={data:[],isLoading:!1,hash:""},c="hooks: usePrivateWidgets:";var d=a(742);const u=e=>Uint8Array.from(e.match(/.{1,2}/g).map((e=>parseInt(e,16)))),{crypto:p}=window,h="utils: crypto:",g="hooks: useExcelkitsCredentials:",m={apiKey:"",secret:"",cypher:null,isLoading:!1,error:null};var y=window.wp.i18n;function w({isPreview:e=!1}){return(0,t.createElement)(r.BlockControls,null,e?(0,t.createElement)(n.ToolbarGroup,null,(0,t.createElement)(n.ToolbarButton,{className:"components-tab-button",isPressed:!0},(0,y.__)("Preview"))):(0,t.createElement)(t.Fragment,null))}var f=({selected:e="",options:a=[],instructions:o,isLoading:l=!1,hasError:i=!1,reload:s=(()=>null),onChange:c=(()=>null),onSelect:d=(()=>null)})=>{const u=(0,y.__)("Excelkits Calculator","excelkits-blocks"),p=(0,y.__)(`${o}`,"excelkits-blocks"),h=(0,y.__)("Try again","excelkits-blocks"),g=(0,y.__)("Select widget","excelkits-blocks"),m=(0,y.__)("Select","excelkits-blocks"),w=(0,y.__)("No widgets available","excelkits-blocks"),f=(0,y.__)("Refresh","excelkits-blocks");return(0,t.createElement)(n.Placeholder,{icon:(0,t.createElement)(r.BlockIcon,{icon:"calculator"}),className:"exk-select-widget-calc",label:u,withIllustration:!0,instructions:p},i?(0,t.createElement)(n.Button,{variant:"primary",onClick:s,text:h}):(0,t.createElement)(t.Fragment,null),!i&&l?(0,t.createElement)(n.Spinner,{style:{width:"26px",height:"26px"},className:"exk-select-widget-calc-spinner"}):(0,t.createElement)(t.Fragment,null),i||l||a.length?(0,t.createElement)(t.Fragment,null):(0,t.createElement)("span",{className:"exk-select-widget-calc-empty"},w," ",(0,t.createElement)("a",{className:"exk-select-widget-calc-link",href:"https://excelkits.com/widgets",rel:"noreferrer",target:"_blank"},"Create First Widget"),"."),i||l||!Boolean(a.length)?(0,t.createElement)(t.Fragment,null):(0,t.createElement)(t.Fragment,null,(0,t.createElement)(n.SelectControl,{className:"exk-select-widget-calc-control",onChange:c,placeholder:g},(0,t.createElement)("option",{disabled:!0,selected:!0,value:!0},"Select widget"),a.map((({value:e,label:a})=>(0,t.createElement)("option",{key:e,value:e},a)))),e?(0,t.createElement)(n.Button,{className:"exk-select-widget-calc-button",onClick:d,variant:"primary",text:m}):(0,t.createElement)(t.Fragment,null),(0,t.createElement)(n.Button,{className:"exk-select-widget-calc-button--alternative",onClick:s,text:f})))},E={free:"Select a free template from the menu below. Or sign up to start creating your own.",auth:"Select one of your custom widgets from the menu below."},k={credentials:"There was an issue with your API Keys, please ensure they are correct in order to access your team's widgets.",sharedWidgetsDownload:"Failed to download free widgets, please try again.",privateWidgetsDownload:"Failed to download your team's widgets, please check your API Keys and try again or contact Excelkits for support."};const v=({message:e="",onRemove:a=(()=>null)})=>e?(0,t.createElement)(n.Snackbar,{status:"error",className:"components-snackbar exk-error-message-notification",icon:(0,t.createElement)("span",{"aria-label":"Icon",role:"img",style:{fontSize:21}},"⚠️"),onRemove:a},e):(0,t.createElement)(t.Fragment,null),b=({isVisible:e})=>e?(0,t.createElement)("img",{className:"exk-block-insert-preview",src:"/wp-content/plugins/excelkits-wp-plugin/public/images/preview.webp",alt:"Calculator widget rendered"}):(0,t.createElement)(t.Fragment,null);(0,e.registerBlockType)("excelkits-blocks/calculator",{edit:function({attributes:e,setAttributes:a,isSelected:y}){const{snippetHtml:x,isBlockInsertPreview:L,apiKey:$,secret:S}=e,{hasCredentials:C,hasLoaded:A,error:B,createAuthorization:K}=(({apiKey:e="",secret:a=""})=>{const[r,n]=(0,t.useState)(!1),[o,l]=(0,t.useState)(!1),[i,s]=(0,t.useState)(m.error);return(0,t.useEffect)((()=>{if(!e||!a)return m.apiKey="",m.secret="",m.cypher=null,m.error=null,n(!0),l(!1),void s(null);m.isLoading||Boolean(m.apiKey&&m.secret&&m.cypher)&&m.apiKey===e&&m.secret===a||(m.isLoading=!0,m.error=null,(async e=>{const[t,a]=`${e||""}`.split("~");if(!t||!a)throw Error(`${g} generateCypher: secret is not correct`);let r=null;try{r=await(async(e,t)=>{const a=u(e),r=u(t);let n=null;try{n=await p.subtle.importKey("raw",a,"AES-CBC",!0,["encrypt","decrypt"])}catch(e){throw Error(`${h} createCypher: failed to import key: ${e}`)}return{async encrypt(e){const t=(new TextEncoder).encode(e);let a=null;try{a=await p.subtle.encrypt({name:"AES-CBC",iv:r},n,t)}catch(e){throw Error(`${h} cypher: encrypt: subtle encryption failed: ${e}`)}return new Uint8Array(a)}}})(a,t)}catch(e){throw Error(`${g} generateCypher: secret was not accepted as a cypher: ${e}`)}return r})(a).then((t=>{m.apiKey=`${e}`,m.secret=`${a}`,m.cypher=t,l(!0)})).catch((e=>{const t=Error(`${g} failed to create cypher: ${e}`);s(t),m.error=t,m.apiKey="",m.secret="",m.cypher=null,l(!1)})).finally((()=>{m.isLoading=!1,n(!0)})))}),[e,a]),(0,t.useEffect)((()=>{if(!m.isLoading)return m.apiKey&&m.secret?Boolean(m.apiKey&&m.secret)?(n(!0),l(!0),void s(null)):void s(m.error):(n(!0),l(!1),void s(m.error))}),[m.apiKey,m.secret,m.isLoading,m.error]),{hasLoaded:r,hasCredentials:o,error:i,createAuthorization:async()=>{if(!m.apiKey||!m.cypher)throw Error("Excelkit API Key credentials not discovered yet");const e=JSON.stringify({createdAt:Math.ceil(Date.now()/1e3)});let t=null;try{t=await m.cypher.encrypt(e)}catch(e){const t=Error(`${g} createAuthorization: failed to create byte array of cypher text: ${e}`);throw s(t),t}let a="";try{a=(0,d.JQ)(t)}catch(e){const t=Error(`${g} createAuthorization: failed to create base64 of cypher text: ${e}`);throw s(t),t}return`${m.apiKey}~${a}`}}})({apiKey:$,secret:S}),{data:_,selectOptions:F,download:P,isLoading:N,error:W}=(({canLoad:e=!1})=>{const[a,r]=(0,t.useState)(i.data),[n,s]=(0,t.useState)(i.isLoading),[c,d]=(0,t.useState)(i.hash),[u,p]=(0,t.useState)(null),h=(0,t.useCallback)((async()=>{g(!0),p(null),r([]),m([]);let e=null;try{if(e=await(async()=>{let e=null,t=null;try{t=await fetch("https://us-central1-excelkits.cloudfunctions.net/api/v0/integrations/shared-widget-snippets")}catch(e){throw Error(`${o} getSharedWidgets: failed to download: ${e}`)}try{e=await t.json()}catch(e){throw Error(`${o} getSharedWidgets: failed to parse payload: ${e}`)}return e})(),!e||!Array.isArray(e.data))throw Error("unexpected payload")}catch(e){const t=Error(`hooks: useSharedWidgets: download: shared widgets request failed: ${e}`);throw p(t),g(!1),t}g(!1);const t=[...e.data.map(l)];return r(t),i.data.length=0,i.data.push(...t),m(t),t}),[]);function g(e){i.isLoading=e,s(e)}function m(e){const t=e.map((({id:e})=>e)).join(",");i.hash=t,d(t)}return(0,t.useEffect)((()=>{n!==i.isLoading&&s(i.isLoading),c!==i.hash&&(d(i.hash),r([...i.data]),p(null))}),[i.isLoading,i.hash]),(0,t.useEffect)((()=>{if(e&&!i.isLoading&&!i.data.length)try{h()}catch(e){}}),[e,h]),{data:a,selectOptions:a.map((({id:e,title:t})=>({value:e,label:t}))),error:u,isLoading:n,download:h}})({canLoad:Boolean(A&&!C)}),{data:z,selectOptions:j,download:I,isLoading:T,error:D}=(({canLoad:e=!1,getAuthorization:a=(()=>Promise.resolve(""))})=>{const[r,n]=(0,t.useState)(s.data),[i,d]=(0,t.useState)(s.isLoading),[u,p]=(0,t.useState)(s.hash),[h,g]=(0,t.useState)(null),m=(0,t.useCallback)((async()=>{y(!0),g(null),n([]),w([]);let e="";try{e=await a()}catch(e){const t=Error(`${c} download: failed to create authorization: ${e}`);throw g(t),y(!1),t}let t=null;try{if(t=await(async e=>{let t=null,a=null;if(!e||"string"!=typeof e)throw Error(`${o} getPrivateWidgets: provided authorization invalid`);try{a=await fetch("https://us-central1-excelkits.cloudfunctions.net/api/v0/integrations/team-widget-snippets",{headers:{"Content-Type":"application/vnd.api+json",Authorization:`api-key ${e}`}})}catch(e){throw Error(`${o} getPrivateWidgets: failed to download: ${e}`)}try{t=await a.json()}catch(e){throw Error(`${o} getPrivateWidgets: failed to parse payload: ${e}`)}return t})(e),!t||!Array.isArray(t.data))throw Error("unexpected payload")}catch(e){const t=Error(`${c} download: private widgets request failed: ${e}`);throw g(t),y(!1),t}y(!1);const r=[...t.data.map(l)];return n(r),s.data.length=0,s.data.push(...r),w(r),r}),[]);function y(e){s.isLoading=e,d(e)}function w(e){const t=e.map((({id:e})=>e)).join(",");s.hash=t,p(t)}return(0,t.useEffect)((()=>{i!==s.isLoading&&d(s.isLoading),u!==s.hash&&(p(s.hash),n([...s.data]),g(null))}),[s.isLoading,s.hash]),(0,t.useEffect)((()=>{if(e&&!s.isLoading&&!s.data.length)try{m()}catch(e){}}),[e,m]),{data:r,selectOptions:r.map((({id:e,title:t})=>({value:e,label:t}))),error:h,isLoading:i,download:m}})({canLoad:Boolean(A&&C&&y),getAuthorization:K}),O=A&&!C,H=!A||O&&!W&&N||A&&C&&!D&&T,[R,U]=(0,t.useState)(""),J=(0,t.useMemo)((()=>B?k.credentials:W?k.sharedWidgetsDownload:D?k.privateWidgetsDownload:""),[B,W,D]);return(0,t.createElement)("div",{...(0,r.useBlockProps)()},(0,t.createElement)(t.Fragment,null,(0,t.createElement)(b,{isVisible:L}),L?(0,t.createElement)(t.Fragment,null):(0,t.createElement)(t.Fragment,null,(0,t.createElement)(w,{isPreview:Boolean(x)}),x?(0,t.createElement)(n.SandBox,{html:x}):(0,t.createElement)(t.Fragment,null,(0,t.createElement)(v,{message:J}),(0,t.createElement)(f,{selected:R,isLoading:H,instructions:O?E.free:E.auth,options:O?F:j,hasError:Boolean(W||D),reload:O?P:I,onChange:e=>U(e),onSelect:()=>((e,t)=>{const r=t.find((({id:t})=>t===e));r&&a({selected:e,snippetHtml:decodeURIComponent(r.snippetHtml)})})(R,O?_:z)})))))},save:function({attributes:e}){const{snippetHtml:a}=e,n=r.useBlockProps.save();return(0,t.createElement)(t.RawHTML,{...n},a)}})}()}();